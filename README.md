
## 通用base

* 一致性查询
  1. 根据条件查询数据库，
  2. 有，通过用户id，查询keystone
     1. 有，返回有
     2. 没有，删除数据库，返回没有
  3. 没有，返回没有
  
* 一致性查询by用户名
  1. 通过用户名，查询keystone
  2. 查询数据库 
  3. 统一数据库和keystone
  4. 返回结果
  
* 手机验证码memcached
  1. 获取验证码 不存在->3
  2. 判断是否频繁 否->3
  3. 生成新值{code:456789,time:new Date()}
  4. 保存到memcached
  5. driver.kiki.send 成功->返回,失败->6
  6. 销毁memcached里刚保存的验证码，返回错误

  
* token邮件memcached
  1.
  

## 注册
  * unique email
    - 数据库查询邮箱
      - 有通过id 查询keystone
        + 有 返回有
        + 没有 删除数据库数据 返回没有
      - 没有 返回没有
  * unique name
    - 查询keystone 
      + 有 返回有
      + 没有 删除数据库 返回没有
      
  * 手机号请求验证码
    1. 验证手机号格式
    2. 查询数据库
      - 没有 继续
      - 有  返回手机号已注册
    3. memcachedGet
      - 有 判断是否太频繁
        - 频繁 返回
        - 不频繁 发送 返回
      - 没有 发送 返回
  
  * 注册
    1. 验证参数
    2. keystone
    3. MySQL
    4. 发送邮件
    
  * 激活
    1. 验证参数
    2. 数据库查找
    3. keystone查找
    4. 判断是否已激活
    5. memcached 验证token
    6. 创建项目
    7. 添加用户到项目
    8. 更新用户enabled 
    9. 更新数据库
    
  * 重新发送激活邮件
    1. 查找数据库
    2. 查找keystone
    3. 用户是否存在 是->继续
    4. 用户是否已激活 否->继续
    5. memcached token 是否频繁 否->继续
    6. 发邮件
    
## 更新

  > 首先判断是否登录

  * 更新用户名
  * 修改密码
  
## 忘记密码
  
  >页面->选择方式（手机、邮箱）
  
### 通过手机修改
  * 发送手机验证码
    1. 数据库
    2. keystone
    3. 发送短信验证码 
    
  * 修改密码


### 通过邮箱修改

  * 发送邮件链接
  * 渲染修改密码页面
  * 修改密码
  
  
  
  
  
## 忘记用户名  
  
  
  
  
# 页面

  1. 注册/登录
  2. 注册成功 同时提示邮件发送成功
  3. 激活成功/失败 
  4. 忘记密码 手机 输入手机号，发送验证码，输入新密码，提交 -> 重置成功
  5. 重新发送邮件 邮箱 
  6. 更换邮箱 输入手机号 验证码 新邮箱 提交 
 
